<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>:::AICLUDE EdgeHD:::</title>
    {% if work_id %}
    <meta name="work-id" content="{{ work_id }}" />
    {% endif %} {% if work_data %}
    <script>
      // ì„œë²„ì—ì„œ ì „ë‹¬ëœ work_dataë¥¼ JavaScript ë³€ìˆ˜ë¡œ ì§ì ‘ ì„¤ì •
      window.serverWorkData = {{ work_data | tojson | safe }};
      console.log("ğŸ”— ì„œë²„ì—ì„œ ì§ì ‘ ì „ë‹¬ëœ work_data:", window.serverWorkData);
    </script>
    {% endif %}
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        overflow-x: hidden;
      }

      .header {
        text-align: center;
        padding: 20px;
        color: white;
      }

      .header h1 {
        font-size: 2.5em;
        font-weight: 700;
        margin-bottom: 10px;
      }

      /* ëª¨ë“œ ì „í™˜ íƒ­ */
      .mode-tabs {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 15px;
      }

      .mode-tab {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 8px 20px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
      }

      .mode-tab:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .mode-tab.active {
        background: white;
        color: #667eea;
        border-color: white;
      }

      .main-container {
        flex: 1;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        padding: 0 20px 20px;
        max-height: calc(100vh - 160px);
        min-height: 500px;
        transition: grid-template-columns 0.3s ease;
      }

      .main-container.upload-only {
        grid-template-columns: 1fr;
        justify-items: center;
      }

      .left-panel {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-height: 350px;
        position: relative;
      }

      .right-panel {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 350px;
        position: relative;
        transition: all 0.3s ease;
      }

      .right-panel.visible {
        display: flex;
      }

      /* ì—…ë¡œë“œ ì˜ì—­ */
      .upload-area {
        border: 3px dashed #ddd;
        border-radius: 12px;
        padding: 40px 15px;
        transition: all 0.3s ease;
        cursor: pointer;
        background: #fafafa;
        text-align: center;
        min-height: 150px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .upload-area:hover {
        border-color: #667eea;
        background: #f0f4ff;
      }

      .upload-area.dragover {
        border-color: #667eea;
        background: #e8f0ff;
        transform: scale(1.02);
      }

      .upload-icon {
        font-size: 3em;
        color: #ddd;
        margin-bottom: 20px;
      }

      .upload-text {
        color: #666;
        font-size: 1.2em;
        margin-bottom: 10px;
      }

      .upload-subtext {
        color: #999;
        font-size: 0.9em;
      }

      #fileInput,
      #videoFileInput {
        display: none;
      }

      /* ë¹„ë””ì˜¤ ëª¨ë“œ UI */
      .video-mode {
        display: none;
      }

      .video-mode.active {
        display: block;
      }

      .image-mode.hidden {
        display: none;
      }

      .video-upload-area {
        border: 3px dashed #ddd;
        border-radius: 12px;
        padding: 40px 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f9f9f9;
        min-height: 150px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .video-upload-area:hover {
        border-color: #aaa;
        background: #f0f0f0;
      }

      .video-upload-area.dragover {
        border-color: #667eea;
        background: #e8f0ff;
        transform: scale(1.02);
      }

      .video-options {
        background: white;
        padding: 20px;
        border-radius: 15px;
        margin-top: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .option-group {
        margin-bottom: 15px;
      }

      .option-group label {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: background 0.2s ease;
      }

      .option-group label:hover {
        background: #f5f5f5;
      }

      .option-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
      }

      .scale-options {
        display: none;
        margin-left: 30px;
        margin-top: 10px;
        gap: 10px;
      }

      .scale-options.visible {
        display: flex;
      }

      .scale-option label {
        background: #f0f0f0;
        padding: 5px 15px;
        border-radius: 15px;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .scale-option input[type="radio"] {
        margin-right: 5px;
      }

      .scale-option label:hover {
        background: #e0e0e0;
      }

      /* ë¹„ë””ì˜¤ ì •ë³´ ì¹´ë“œë“¤ (ì™¼ìª½ íŒ¨ë„ì— ê°€ë¡œ ë°°ì¹˜) */
      .video-info-container {
        display: flex;
        gap: 15px;
        margin: 15px 0;
        flex-wrap: wrap;
      }

      .video-info-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        flex: 1;
        min-width: 200px;
      }

      .video-info-title {
        font-size: 1em;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .video-info-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 6px;
        font-size: 0.85em;
      }

      .video-info-label {
        color: #666;
        font-weight: 500;
      }

      .video-info-value {
        color: #333;
        font-weight: 600;
      }

      /* ë°°ê²½ ìƒ‰ìƒ ì„ íƒ íŒì—… */
      .background-color-popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }

      .popup-content {
        background: white;
        border-radius: 15px;
        padding: 25px;
        max-width: 400px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      }

      .popup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
      }

      .popup-title {
        font-size: 1.3em;
        font-weight: 700;
        color: #333;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 1.5em;
        cursor: pointer;
        color: #999;
        padding: 5px;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .close-btn:hover {
        background: #f0f0f0;
        color: #333;
      }

      .background-color-section {
        margin-bottom: 20px;
      }

      .color-section-title {
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
        font-size: 1.1em;
      }

      .preset-colors {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .color-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 3px solid transparent;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .color-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .color-btn.active {
        border-color: #667eea !important;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        transform: scale(1.15);
      }

      .custom-color-section {
        display: flex;
        align-items: center;
        gap: 15px;
        justify-content: center;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
      }

      .custom-color-section label {
        font-weight: 600;
        color: #666;
      }

      .custom-color-picker {
        width: 50px;
        height: 50px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .popup-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      .popup-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 25px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 120px;
      }

      .popup-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      }

      .popup-btn.cancel {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      }

      /* ì²˜ë¦¬ ë©”ì‹œì§€ (íŒ¨ë„ì— ì§ì ‘ í‘œì‹œ) */
      .processing-message {
        background: none;
        color: #666;
        border-radius: 0;
        padding: 20px 10px;
        text-align: center;
        margin: 20px 0;
        animation: none;
        box-shadow: none;
      }

      .processing-main-message {
        font-size: 1.1em;
        font-weight: 600;
        margin-bottom: 8px;
        line-height: 1.4;
        color: #333;
      }

      .processing-tip-message {
        font-size: 0.9em;
        opacity: 0.8;
        font-style: italic;
        line-height: 1.3;
        color: #666;
      }

      @keyframes fadeInMessage {
        from {
          opacity: 0;
          transform: translateY(15px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* ë¹„ë””ì˜¤ ì™„ë£Œ ê²°ê³¼ */
      .video-result-section {
        background: none;
        color: #333;
        border-radius: 0;
        padding: 20px 10px;
        margin: 20px 0;
        text-align: center;
        animation: none;
        box-shadow: none;
      }

      .result-title {
        font-size: 1.2em;
        font-weight: 600;
        margin-bottom: 15px;
        color: #28a745;
      }

      /* ì´ë¯¸ì§€ í‘œì‹œ ì˜ì—­ */
      .image-display-area {
        display: none;
        flex-direction: column;
        align-items: center;
        text-align: center;
        height: 100%;
      }

      .image-display-area.visible {
        display: flex;
      }

      /* ë¹„ë””ì˜¤ ì²˜ë¦¬ ìƒíƒœ í‘œì‹œ ì˜ì—­ */
      .video-status-area {
        display: none;
        flex-direction: column;
        align-items: center;
        text-align: center;
        height: 100%;
        padding: 30px 15px;
        background: none;
        border-radius: 0;
        overflow-y: auto;
      }

      .video-status-area.visible {
        display: flex;
      }

      .processing-status-container {
        display: flex;
        justify-content: center;
        width: 100%;
        max-width: 350px;
        margin-bottom: 15px;
      }

      .fun-message-card {
        background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
        color: white;
        border-radius: 8px;
        padding: 12px 16px;
        text-align: center;
        animation: fadeInMessage 0.5s ease-in;
        width: 100%;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .fun-message {
        font-size: 0.85em;
        line-height: 1.3;
        margin-bottom: 4px;
      }

      .fun-tip {
        font-size: 0.75em;
        opacity: 0.9;
        font-style: italic;
        line-height: 1.2;
      }

      .fun-message {
        font-size: 1em;
        line-height: 1.4;
        margin-bottom: 8px;
      }

      .fun-tip {
        font-size: 0.85em;
        opacity: 0.9;
        font-style: italic;
      }

      .video-result-area {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        width: 100%;
        max-width: 300px;
        text-align: center;
        animation: fadeInMessage 0.5s ease-in;
      }

      .image-container {
        position: relative;
        max-width: 100%;
        max-height: 50vh;
        margin-bottom: 15px;
      }

      .image-display {
        max-width: 100%;
        max-height: 50vh;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      /* ë¹„ë””ì˜¤ í‘œì‹œ ì˜ì—­ */
      .video-display-area {
        display: none;
        flex-direction: column;
        align-items: center;
        text-align: center;
        height: 100%;
      }

      .video-display-area.visible {
        display: flex;
      }

      .video-container {
        position: relative;
        max-width: 100%;
        max-height: 50vh;
        margin-bottom: 15px;
      }

      .video-display {
        max-width: 100%;
        max-height: 50vh;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        background: #000;
      }

      .video-info-display {
        background: linear-gradient(135deg, #f8f9ff 0%, #f0f3ff 100%);
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 12px;
        font-size: 0.85em;
        color: #666;
        max-width: 100%;
        text-align: left;
      }

      .video-info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
      }

      .video-info-row:last-child {
        margin-bottom: 0;
      }

      .video-info-label {
        font-weight: 500;
      }

      .video-info-value {
        color: #333;
        font-weight: 600;
      }

      .image-label {
        margin: 12px 0 8px;
        font-weight: 600;
        color: #333;
        font-size: 1em;
      }

      /* ì•¡ì…˜ ë²„íŠ¼ë“¤ */
      .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        margin-top: 15px;
      }

      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 100px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn.upscale-2x {
        background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
      }

      .btn.upscale-4x {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      }

      .btn.background-remove {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .btn.download {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      }

      .btn.reset {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      }

      /* ìƒ‰ìƒ ì„ íƒ ë²„íŠ¼ */
      .color-btn {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .color-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      .color-btn.active {
        border-color: #667eea !important;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
        transform: scale(1.1);
      }

      /* ë©”ì‹œì§€ */
      .message-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        max-width: 90%;
      }

      .error-message {
        color: #e74c3c;
        background: #ffeaea;
        padding: 15px;
        border-radius: 10px;
        border-left: 4px solid #e74c3c;
      }

      .success-message {
        color: #27ae60;
        background: #eafaf1;
        padding: 15px;
        border-radius: 10px;
        border-left: 4px solid #27ae60;
      }

      /* ë¹ˆ ìƒíƒœ */
      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #999;
        height: 100%;
      }

      .empty-state.hide {
        display: none;
      }

      .empty-icon {
        font-size: 3em;
        margin-bottom: 15px;
        opacity: 0.5;
      }

      .empty-text {
        font-size: 1.1em;
      }

      /* íˆ¬ëª…ë„ ì²´í¬ë³´ë“œ ë°°ê²½ */
      .transparency-bg {
        background-image: linear-gradient(45deg, #f0f0f0 25%, transparent 25%),
          linear-gradient(-45deg, #f0f0f0 25%, transparent 25%),
          linear-gradient(45deg, transparent 75%, #f0f0f0 75%),
          linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
        background-size: 20px 20px;
        background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
      }

      /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
      @media (max-width: 768px) {
        .header h1 {
          font-size: 2em;
        }

        .header {
          padding: 15px;
        }

        .main-container,
        .main-container.upload-only {
          grid-template-columns: 1fr;
          gap: 15px;
          padding: 0 15px 15px;
          max-height: none;
          justify-items: stretch;
        }

        .left-panel,
        .right-panel {
          padding: 15px;
          min-height: 250px;
        }

        .upload-area {
          padding: 30px 12px;
          min-height: 120px;
        }

        .upload-icon {
          font-size: 2.2em;
        }

        .upload-text {
          font-size: 1em;
        }

        .action-buttons {
          flex-direction: column;
          align-items: center;
        }

        .btn {
          width: 100%;
          max-width: 200px;
        }

        .image-display {
          max-height: 40vh;
        }

        .processing-status-container {
          max-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>ğŸ«¥ ğŸ–¼ï¸ âœ‚ï¸ ğŸ”¥ ğŸ‘¨ğŸ»â€ğŸ’» AICLUDE EdgeHD</h1>
      <div class="mode-tabs">
        <div class="mode-tab active" onclick="switchMode('image')">
          ğŸ–¼ï¸ ì´ë¯¸ì§€ ì²˜ë¦¬
        </div>
        <div class="mode-tab" onclick="switchMode('video')">ğŸ¬ ë¹„ë””ì˜¤ ì²˜ë¦¬</div>
      </div>
    </div>

    <div class="main-container" id="mainContainer">
      <!-- ì¢Œì¸¡ íŒ¨ë„ -->
      <div class="left-panel">
        <!-- ì´ë¯¸ì§€ ëª¨ë“œ -->
        <div class="image-mode" id="imageMode">
          <!-- ì—…ë¡œë“œ ì˜ì—­ -->
          <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“¸</div>
            <div class="upload-text">í´ë¦­í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•´ì£¼ì„¸ìš”</div>
            <div class="upload-subtext">
              PNG, JPG, JPEG, GIF, BMP, WEBP (ìµœëŒ€ 16MB)
            </div>
          </div>
        </div>

        <!-- ë¹„ë””ì˜¤ ëª¨ë“œ -->
        <div class="video-mode" id="videoMode">
          <!-- ë¹„ë””ì˜¤ ì—…ë¡œë“œ ì˜ì—­ -->
          <div class="video-upload-area" id="videoUploadArea">
            <div class="upload-icon">ğŸ¬</div>
            <div class="upload-text">í´ë¦­í•˜ê±°ë‚˜ ë¹„ë””ì˜¤ë¥¼ ë“œë˜ê·¸í•´ì£¼ì„¸ìš”</div>
            <div class="upload-subtext">MP4, AVI, MOV, MKV (ìµœëŒ€ 100MB)</div>
          </div>
        </div>

        <!-- ì´ë¯¸ì§€ í‘œì‹œ ì˜ì—­ -->
        <div class="image-display-area" id="leftImageArea">
          <div class="image-container">
            <img id="leftImage" class="image-display" alt="í˜„ì¬ ì´ë¯¸ì§€" />
          </div>
          <div class="image-label" id="leftImageLabel">ì—…ë¡œë“œëœ ì´ë¯¸ì§€</div>
          <div class="action-buttons" id="leftActionButtons">
            <button class="btn upscale-2x" onclick="processImage('upscale', 2)">
              ğŸ” 2x ì—…ìŠ¤ì¼€ì¼
            </button>
            <button class="btn upscale-4x" onclick="processImage('upscale', 4)">
              ğŸ” 4x ì—…ìŠ¤ì¼€ì¼
            </button>
            <button
              class="btn background-remove"
              onclick="processImage('background')"
            >
              ğŸ«¥ ë°°ê²½ ì œê±°
            </button>
          </div>
        </div>

        <!-- ë¹„ë””ì˜¤ í‘œì‹œ ì˜ì—­ -->
        <div class="video-display-area" id="leftVideoArea">
          <div class="video-container">
            <video
              id="leftVideo"
              class="video-display"
              controls
              alt="ì—…ë¡œë“œëœ ë¹„ë””ì˜¤"
            >
              ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ ì¬ìƒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </video>
          </div>

          <div class="image-label" id="leftVideoLabel">ì—…ë¡œë“œëœ ë¹„ë””ì˜¤</div>

          <!-- ë¹„ë””ì˜¤ ì •ë³´ ì¹´ë“œë“¤ (ê°€ë¡œ ë°°ì¹˜) -->
          <div class="video-info-container">
            <!-- ì›ë³¸ ë¹„ë””ì˜¤ ì •ë³´ -->
            <div class="video-info-card">
              <div class="video-info-title">ğŸ“¹ ì›ë³¸ ë¹„ë””ì˜¤</div>
              <div class="video-info-item">
                <span class="video-info-label">íŒŒì¼ í¬ë§·:</span>
                <span class="video-info-value" id="videoFormat">-</span>
              </div>
              <div class="video-info-item">
                <span class="video-info-label">í•´ìƒë„:</span>
                <span class="video-info-value" id="videoResolution">-</span>
              </div>
              <div class="video-info-item">
                <span class="video-info-label">í”„ë ˆì„ìœ¨:</span>
                <span class="video-info-value" id="videoFPS">-</span>
              </div>
              <div class="video-info-item">
                <span class="video-info-label">ì´ í”„ë ˆì„:</span>
                <span class="video-info-value" id="videoTotalFrames">-</span>
              </div>
            </div>

            <!-- ì²˜ë¦¬ë  ë¹„ë””ì˜¤ ì •ë³´ -->
            <div class="video-info-card">
              <div class="video-info-title">ğŸ¬ ì²˜ë¦¬ë  ë¹„ë””ì˜¤</div>
              <div class="video-info-item">
                <span class="video-info-label">ë³€ê²½ í•´ìƒë„:</span>
                <span class="video-info-value" id="processedResolution"
                  >ì›ë³¸ê³¼ ë™ì¼</span
                >
              </div>
              <div class="video-info-item">
                <span class="video-info-label">ë°°ê²½ ì œê±°:</span>
                <span class="video-info-value" id="backgroundRemoval"
                  >ì ìš© ì˜ˆì •</span
                >
              </div>
              <div class="video-info-item">
                <span class="video-info-label">ì—…ìŠ¤ì¼€ì¼:</span>
                <span class="video-info-value" id="upscaleInfo">ì ìš© ì˜ˆì •</span>
              </div>
              <div class="video-info-item">
                <span class="video-info-label">ì¶œë ¥ í¬ë§·:</span>
                <span class="video-info-value">MP4 (H.264)</span>
              </div>
            </div>
          </div>

          <div class="action-buttons" id="leftVideoActionButtons">
            <button
              class="btn background-remove"
              onclick="showBackgroundColorPopup('remove_bg')"
            >
              ğŸ«¥ ë°°ê²½ ì œê±°
            </button>
            <button
              class="btn upscale-2x"
              onclick="startVideoProcessing('upscale_2x')"
            >
              ğŸ” 2x ì—…ìŠ¤ì¼€ì¼
            </button>
            <button
              class="btn upscale-4x"
              onclick="startVideoProcessing('upscale_4x')"
            >
              ğŸ” 4x ì—…ìŠ¤ì¼€ì¼
            </button>
            <button
              class="btn"
              onclick="showBackgroundColorPopup('both_2x')"
              style="
                background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
              "
            >
              ğŸ¬ ë°°ê²½ì œê±° + 2x
            </button>
            <button
              class="btn"
              onclick="showBackgroundColorPopup('both_4x')"
              style="
                background: linear-gradient(135deg, #a55eea 0%, #8b2ac7 100%);
              "
            >
              ğŸ¬ ë°°ê²½ì œê±° + 4x
            </button>
          </div>
        </div>

        <input type="file" id="fileInput" accept="image/*" />
      </div>

      <!-- ìš°ì¸¡ íŒ¨ë„ -->
      <div class="right-panel" id="rightPanel">
        <!-- ë¹ˆ ìƒíƒœ -->
        <div class="empty-state" id="emptyState">
          <div class="empty-icon" id="emptyIcon">ğŸ–¼ï¸</div>
          <div class="empty-text" id="emptyText">
            ì´ë¯¸ì§€ë¥¼ ì²˜ë¦¬í•˜ë©´<br />ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
          </div>
        </div>

        <!-- ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
        <div class="image-display-area" id="rightImageArea">
          <div class="image-container">
            <img id="rightImage" class="image-display" alt="ì²˜ë¦¬ ê²°ê³¼" />
          </div>
          <div class="image-label" id="rightImageLabel">ì²˜ë¦¬ ê²°ê³¼</div>
          <div class="action-buttons" id="rightActionButtons">
            <button class="btn download" id="downloadBtn">ğŸ”½ ë‹¤ìš´ë¡œë“œ</button>
            <button
              class="btn upscale-2x"
              onclick="continueProcessing('upscale', 2)"
            >
              ğŸ” 2x ì—…ìŠ¤ì¼€ì¼
            </button>
            <button
              class="btn upscale-4x"
              onclick="continueProcessing('upscale', 4)"
            >
              ğŸ” 4x ì—…ìŠ¤ì¼€ì¼
            </button>
            <button
              class="btn background-remove"
              onclick="continueProcessing('background')"
            >
              ğŸ«¥ ë°°ê²½ ì œê±°
            </button>
          </div>
        </div>

        <!-- ë¹„ë””ì˜¤ ì²˜ë¦¬ ìƒíƒœ í‘œì‹œ ì˜ì—­ -->
        <div class="video-status-area" id="videoStatusArea">
          <!-- ì²˜ë¦¬ ë©”ì‹œì§€ (íŒ¨ë„ì— ì§ì ‘ í‘œì‹œ) -->
          <div
            class="processing-message"
            id="processingMessage"
            style="display: block"
          >
            <div class="processing-main-message" id="processingMainMessage">
              ğŸ¤– AIê°€ ì—´ì‹¬íˆ ì‘ì—…í•˜ê³  ìˆìŠµë‹ˆë‹¤!
            </div>
            <div class="processing-tip-message" id="processingTipMessage">
              ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” âœ¨
            </div>
          </div>

          <!-- ë¹„ë””ì˜¤ ì™„ë£Œ ê²°ê³¼ -->
          <div
            class="video-result-section"
            id="videoResultSection"
            style="display: none"
          >
            <div class="result-title">ğŸ‰ ë¹„ë””ì˜¤ ì²˜ë¦¬ ì™„ë£Œ!</div>
            <div class="action-buttons">
              <button class="btn download" id="videoDownloadBtn">
                ğŸ”½ ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ë°°ê²½ ìƒ‰ìƒ ì„ íƒ íŒì—… -->
    <div class="background-color-popup" id="backgroundColorPopup">
      <div class="popup-content">
        <div class="popup-header">
          <div class="popup-title">ğŸ¨ ë°°ê²½ ìƒ‰ìƒ ì„ íƒ</div>
          <button class="close-btn" onclick="hideBackgroundColorPopup()">
            Ã—
          </button>
        </div>

        <div class="background-color-section">
          <div class="color-section-title">ì‚¬ì „ ì •ì˜ ìƒ‰ìƒ</div>
          <div class="preset-colors">
            <button
              class="color-btn active"
              data-color="#FFFFFF"
              style="background: #ffffff; border: 3px solid #ddd"
              title="í°ìƒ‰"
            >
              âšª
            </button>
            <button
              class="color-btn"
              data-color="#00FF00"
              style="background: #00ff00"
              title="ì´ˆë¡ (í¬ë¡œë§ˆí‚¤)"
            >
              ğŸŸ¢
            </button>
            <button
              class="color-btn"
              data-color="#0000FF"
              style="background: #0000ff"
              title="íŒŒë‘ (í¬ë¡œë§ˆí‚¤)"
            >
              ğŸ”µ
            </button>
            <button
              class="color-btn"
              data-color="#000000"
              style="background: #000000"
              title="ê²€ì •"
            >
              âš«
            </button>
            <button
              class="color-btn"
              data-color="#FF0000"
              style="background: #ff0000"
              title="ë¹¨ê°•"
            >
              ğŸ”´
            </button>
            <button
              class="color-btn"
              data-color="#FFFF00"
              style="background: #ffff00"
              title="ë…¸ë‘"
            >
              ğŸŸ¡
            </button>
            <button
              class="color-btn"
              data-color="#FF00FF"
              style="background: #ff00ff"
              title="ìì£¼"
            >
              ğŸŸ£
            </button>
          </div>

          <div class="custom-color-section">
            <label for="popupCustomColorPicker">ì»¤ìŠ¤í…€ ìƒ‰ìƒ:</label>
            <input
              type="color"
              id="popupCustomColorPicker"
              class="custom-color-picker"
              value="#FFFFFF"
            />
          </div>
        </div>

        <div class="popup-actions">
          <button class="popup-btn cancel" onclick="hideBackgroundColorPopup()">
            ì·¨ì†Œ
          </button>
          <button class="popup-btn" onclick="confirmBackgroundColor()">
            í™•ì¸í•˜ê³  ì²˜ë¦¬ ì‹œì‘
          </button>
        </div>
      </div>
    </div>

    <!-- íŒŒì¼ ì…ë ¥ ìš”ì†Œë“¤ -->
    <input type="file" id="fileInput" accept="image/*" />
    <input type="file" id="videoFileInput" accept="video/*" />

    <!-- ì „ì—­ ì»¨íŠ¸ë¡¤ -->
    <div style="position: fixed; top: 20px; right: 20px; z-index: 1000">
      <button class="btn reset" onclick="resetApplication()">
        ğŸ”„ ë‹¤ì‹œ ì‹œì‘
      </button>
    </div>

    <!-- ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ -->
    <div class="message-container" id="messageContainer"></div>

    <script>
      // ë°±ì—”ë“œë¡œë¶€í„° ì „ë‹¬ë°›ì€ ë°ì´í„°
      // Jinja2 í…œí”Œë¦¿ êµ¬ë¬¸ì„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
      let workId = "";
      let workData = null;

      // ì„œë²„ì—ì„œ ì „ë‹¬ëœ ë°ì´í„°ê°€ ìˆë‹¤ë©´ ì„¤ì •
      try {
        const serverWorkId = document.querySelector('meta[name="work-id"]');

        console.log("ğŸ” ë””ë²„ê¹… - serverWorkId:", serverWorkId);

        if (serverWorkId) {
          workId = serverWorkId.content;
          console.log("âœ… workId ì„¤ì •ë¨:", workId);
        }

        // work_dataëŠ” script íƒœê·¸ì—ì„œ ì§ì ‘ ì„¤ì •ëœ window.serverWorkData ì‚¬ìš©
        if (window.serverWorkData) {
          workData = window.serverWorkData;
          console.log("âœ… workData ì„¤ì •ë¨ (script íƒœê·¸):", workData);
        } else {
          console.log("âŒ window.serverWorkDataê°€ ì—†ìŒ");
        }
      } catch (e) {
        console.error("âŒ ì„œë²„ ë°ì´í„° ì„¤ì • ì‹¤íŒ¨:", e);
      }

      // DOM ìš”ì†Œë“¤
      const fileInput = document.getElementById("fileInput");
      const videoFileInput = document.getElementById("videoFileInput");
      const uploadArea = document.getElementById("uploadArea");
      const videoUploadArea = document.getElementById("videoUploadArea");
      const imageMode = document.getElementById("imageMode");
      const videoMode = document.getElementById("videoMode");
      const videoOptions = document.getElementById("videoOptions");
      const mainContainer = document.getElementById("mainContainer");
      const rightPanel = document.getElementById("rightPanel");
      const leftImageArea = document.getElementById("leftImageArea");
      const rightImageArea = document.getElementById("rightImageArea");
      const videoStatusArea = document.getElementById("videoStatusArea");
      const leftImage = document.getElementById("leftImage");
      const rightImage = document.getElementById("rightImage");
      const leftImageLabel = document.getElementById("leftImageLabel");
      const rightImageLabel = document.getElementById("rightImageLabel");
      const leftActionButtons = document.getElementById("leftActionButtons");
      const rightActionButtons = document.getElementById("rightActionButtons");
      const emptyState = document.getElementById("emptyState");
      const messageContainer = document.getElementById("messageContainer");
      const downloadBtn = document.getElementById("downloadBtn");

      // ë¹„ë””ì˜¤ ê´€ë ¨ DOM ìš”ì†Œë“¤
      const leftVideoArea = document.getElementById("leftVideoArea");
      const leftVideo = document.getElementById("leftVideo");
      const leftVideoLabel = document.getElementById("leftVideoLabel");
      const leftVideoActionButtons = document.getElementById(
        "leftVideoActionButtons"
      );

      const videoResolution = document.getElementById("videoResolution");
      const videoFPS = document.getElementById("videoFPS");
      const videoTotalFrames = document.getElementById("videoTotalFrames");
      const processingMessage = document.getElementById("processingMessage");
      const processingMainMessage = document.getElementById(
        "processingMainMessage"
      );
      const processingTipMessage = document.getElementById(
        "processingTipMessage"
      );
      const videoResultSection = document.getElementById("videoResultSection");
      const videoDownloadBtn = document.getElementById("videoDownloadBtn");

      // ë°°ê²½ ìƒ‰ìƒ íŒì—… ê´€ë ¨ ìš”ì†Œë“¤
      const backgroundColorPopup = document.getElementById(
        "backgroundColorPopup"
      );
      const popupCustomColorPicker = document.getElementById(
        "popupCustomColorPicker"
      );

      // í”„ë ˆì„ ì¹´ìš´í„°ì™€ ì‹œê°„ í‘œì‹œ ìš”ì†Œë“¤ (ì—†ìœ¼ë©´ null)
      const currentFrameNumber = document.getElementById("currentFrameNumber");
      const remainingTime = document.getElementById("remainingTime");

      // ì „ì—­ ë³€ìˆ˜
      let currentImageFile = null;
      let currentVideoFile = null;
      let currentDownloadUrl = null;
      let isTransparentImage = false;
      let currentMode = "image";
      let videoProcessingData = null;
      let messageInterval = null;
      let processingStartTime = null;
      let selectedBackgroundColor = "#FFFFFF"; // ê¸°ë³¸ ë°°ê²½ìƒ‰
      let pendingProcessingMode = null; // íŒì—…ì—ì„œ ì„ íƒëœ ì²˜ë¦¬ ëª¨ë“œ

      // ì‹¤ì œ í”„ë ˆì„ ì²˜ë¦¬ ì‹œì‘ ì‹œê°„ (window ê°ì²´ì— ì €ì¥)
      window.actualProcessingStartTime = null;

      // ì¬ë¯¸ìˆëŠ” ë©”ì‹œì§€ë“¤
      const funMessages = [
        {
          msg: "ğŸ¤– AIê°€ ê° í”„ë ˆì„ì„ ê¼¼ê¼¼íˆ ë¶„ì„í•˜ê³  ìˆì–´ìš”!",
          tip: "ë†’ì€ í’ˆì§ˆì„ ìœ„í•´ì„œëŠ” ì‹œê°„ì´ ì¡°ê¸ˆ í•„ìš”í•´ìš” âœ¨",
        },
        {
          msg: "ğŸ¨ ë§ˆë²•ê°™ì€ ë°°ê²½ ì œê±°ê°€ ì§„í–‰ ì¤‘ì´ì—ìš”!",
          tip: "ê³§ ë†€ë¼ìš´ ê²°ê³¼ë¥¼ ë³´ì‹¤ ìˆ˜ ìˆì„ ê±°ì˜ˆìš” ğŸ­",
        },
        {
          msg: "ğŸ” ì´ë¯¸ì§€ë¥¼ ë” ì„ ëª…í•˜ê²Œ ë§Œë“¤ê³  ìˆì–´ìš”!",
          tip: "ì—…ìŠ¤ì¼€ì¼ë§ì€ í”½ì…€ í•˜ë‚˜í•˜ë‚˜ë¥¼ ì •êµí•˜ê²Œ ì²˜ë¦¬í•´ìš” ğŸ¯",
        },
        {
          msg: "âš¡ GPUê°€ ì—´ì‹¬íˆ ê³„ì‚°í•˜ê³  ìˆì–´ìš”!",
          tip: "AI ëª¨ë¸ì´ ë³µì¡í•œ ì—°ì‚°ì„ ìˆ˜í–‰ ì¤‘ì´ì—ìš” ğŸ§ ",
        },
        {
          msg: "ğŸ¬ ì˜í™” ê°™ì€ í’ˆì§ˆë¡œ ë³€í™˜ ì¤‘ì´ì—ìš”!",
          tip: "í”„ë¡œí˜ì…”ë„í•œ ê²°ê³¼ë¬¼ì„ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš” ğŸª",
        },
        {
          msg: "ğŸš€ ê±°ì˜ ë‹¤ ì™”ì–´ìš”! ì¡°ê¸ˆë§Œ ë” ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”!",
          tip: "ë§ˆì§€ë§‰ ë§ˆë¬´ë¦¬ ì‘ì—…ì´ ì§„í–‰ ì¤‘ì´ì—ìš” â°",
        },
        {
          msg: "ğŸŒŸ ê° í”„ë ˆì„ì— íŠ¹ë³„í•œ ë§ˆë²•ì„ ê±¸ê³  ìˆì–´ìš”!",
          tip: "AIê°€ ë””í…Œì¼ê¹Œì§€ ë†“ì¹˜ì§€ ì•Šê³  ì²˜ë¦¬í•´ìš” ğŸ”¬",
        },
        {
          msg: "ğŸ­ ë°°ê²½ê³¼ ê°ì²´ë¥¼ ì •ë°€í•˜ê²Œ êµ¬ë¶„í•˜ê³  ìˆì–´ìš”!",
          tip: "ìˆ˜ì²œ ë²ˆì˜ í•™ìŠµìœ¼ë¡œ ì™„ì„±ëœ AI ê¸°ìˆ ì´ì—ìš” ğŸ“š",
        },
        {
          msg: "ğŸ’ ë‹¤ì´ì•„ëª¬ë“œì²˜ëŸ¼ íˆ¬ëª…í•˜ê³  ê¹”ë”í•˜ê²Œ!",
          tip: "ì™„ë²½í•œ íˆ¬ëª…ë„ ì²˜ë¦¬ë¥¼ ìœ„í•´ ë…¸ë ¥í•˜ê³  ìˆì–´ìš” ğŸ’",
        },
        {
          msg: "ğŸª ì„œì»¤ìŠ¤ë‹¨ì˜ ê³¡ì˜ˆì‚¬ì²˜ëŸ¼ ì •êµí•˜ê²Œ!",
          tip: "ê· í˜•ì¡íŒ ì²˜ë¦¬ë¡œ ìì—°ìŠ¤ëŸ¬ìš´ ê²°ê³¼ë¥¼ ë§Œë“¤ì–´ìš” ğŸ¤¹",
        },
      ];

      const processingTips = [
        "ğŸ’¡ íŒ: í•´ìƒë„ê°€ ë†’ì„ìˆ˜ë¡ ë” ì˜¤ë˜ ê±¸ë¦¬ì§€ë§Œ í’ˆì§ˆë„ ì¢‹ì•„ì ¸ìš”!",
        "âš¡ íŒ: GPU ì‚¬ìš© ì‹œ CPU ëŒ€ë¹„ 5-10ë°° ë¹ ë¥¸ ì²˜ë¦¬ê°€ ê°€ëŠ¥í•´ìš”!",
        "ğŸ¯ íŒ: ë°°ê²½ì´ ë³µì¡í• ìˆ˜ë¡ AIê°€ ë” ì—´ì‹¬íˆ ë¶„ì„í•´ìš”!",
        "ğŸŒˆ íŒ: ë‹¤ì–‘í•œ ìƒ‰ìƒì´ ìˆëŠ” ì˜ìƒì¼ìˆ˜ë¡ ì²˜ë¦¬ ì‹œê°„ì´ ëŠ˜ì–´ë‚  ìˆ˜ ìˆì–´ìš”!",
        "ğŸ“± íŒ: ëª¨ë°”ì¼ì—ì„œ ì´¬ì˜í•œ ì˜ìƒë„ ì™„ë²½í•˜ê²Œ ì²˜ë¦¬ ê°€ëŠ¥í•´ìš”!",
        "ğŸ¨ íŒ: ì• ë‹ˆë©”ì´ì…˜ì´ë‚˜ ê·¸ë˜í”½ ì˜ìƒë„ ì§€ì›í•´ìš”!",
        "â­ íŒ: ì¸ë¬¼ ì˜ìƒì—ì„œ íŠ¹íˆ ë›°ì–´ë‚œ ì„±ëŠ¥ì„ ë³´ì—¬ì¤ë‹ˆë‹¤!",
        "ğŸ”¥ íŒ: ì‹¤ì‹œê°„ì´ ì•„ë‹Œ ê³ í’ˆì§ˆ ì²˜ë¦¬ë¥¼ ìœ„í•´ ì‹œê°„ì„ íˆ¬ìí•˜ê³  ìˆì–´ìš”!",
      ];

      // UUID ìƒì„± í•¨ìˆ˜
      function generateUUID() {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
          /[xy]/g,
          function (c) {
            const r = (Math.random() * 16) | 0;
            const v = c == "x" ? r : (r & 0x3) | 0x8;
            return v.toString(16);
          }
        );
      }

      // ëª¨ë“œë³„ ë¹ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
      function updateEmptyState() {
        const emptyIcon = document.getElementById("emptyIcon");
        const emptyText = document.getElementById("emptyText");

        if (currentMode === "video") {
          emptyIcon.textContent = "ğŸ¬";
          emptyText.innerHTML =
            "ë¹„ë””ì˜¤ë¥¼ ì²˜ë¦¬í•˜ë©´<br />ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤";
        } else {
          emptyIcon.textContent = "ğŸ–¼ï¸";
          emptyText.innerHTML =
            "ì´ë¯¸ì§€ë¥¼ ì²˜ë¦¬í•˜ë©´<br />ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤";
        }
      }

      // ëª¨ë“œ ì „í™˜ í•¨ìˆ˜
      function switchMode(mode) {
        currentMode = mode;
        const tabs = document.querySelectorAll(".mode-tab");
        tabs.forEach((tab) => tab.classList.remove("active"));

        if (mode === "image") {
          tabs[0].classList.add("active");
          imageMode.classList.remove("hidden");
          videoMode.classList.remove("active");
          initializeApp();
        } else if (mode === "video") {
          tabs[1].classList.add("active");
          imageMode.classList.add("hidden");
          videoMode.classList.add("active");
          initializeVideoMode();
        }

        updateEmptyState();
      }

      // ì´ë¯¸ì§€ ëª¨ë“œ ì´ˆê¸°í™”
      function initializeApp() {
        if (currentMode !== "image") return;

        uploadArea.style.display = "flex";
        leftImageArea.classList.remove("visible");
        leftVideoArea.classList.remove("visible"); // ë¹„ë””ì˜¤ ì˜ì—­ ìˆ¨ê¸°ê¸°
        rightPanel.classList.remove("visible");
        videoStatusArea.classList.remove("visible"); // ë¹„ë””ì˜¤ ìƒíƒœ ì˜ì—­ ìˆ¨ê¸°ê¸°
        mainContainer.classList.add("upload-only");
        emptyState.classList.remove("hide");
        rightImageArea.classList.remove("visible");
        messageContainer.innerHTML = "";
        currentImageFile = null;
        currentDownloadUrl = null;
        isTransparentImage = false;
      }

      // ë¹„ë””ì˜¤ ëª¨ë“œ ì´ˆê¸°í™”
      function initializeVideoMode() {
        videoUploadArea.style.display = "flex";
        leftVideoArea.classList.remove("visible");
        rightPanel.classList.remove("visible");
        videoStatusArea.classList.remove("visible");
        mainContainer.classList.add("upload-only");
        emptyState.classList.remove("hide");
        currentVideoFile = null;
        currentDownloadUrl = null;

        // ë¹„ë””ì˜¤ ì²˜ë¦¬ ê´€ë ¨ ì •ë¦¬
        stopFileCountPolling();
        if (messageInterval) {
          clearInterval(messageInterval);
          messageInterval = null;
        }

        // ê²°ê³¼ ì˜ì—­ ìˆ¨ê¸°ê¸°
        if (videoResultSection) {
          videoResultSection.style.display = "none";
        }

        // ì²˜ë¦¬ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
        if (processingMessage) {
          processingMessage.style.display = "none";
        }
      }

      // ì—…ìŠ¤ì¼€ì¼ ì˜µì…˜ í† ê¸€ (ì‚¬ìš©í•˜ì§€ ì•ŠìŒ - í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€)
      function toggleScaleOptions() {
        // ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ - ìƒˆë¡œìš´ UIì—ì„œëŠ” ë²„íŠ¼ìœ¼ë¡œ ì§ì ‘ ì„ íƒ
      }

      // ë°°ê²½ ìƒ‰ìƒ íŒì—… í‘œì‹œ
      function showBackgroundColorPopup(mode) {
        console.log("ğŸ¨ ë°°ê²½ ìƒ‰ìƒ íŒì—… í‘œì‹œ, mode:", mode);
        pendingProcessingMode = mode;
        backgroundColorPopup.style.display = "flex";

        // íŒì—… ë‚´ ìƒ‰ìƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ì„¤ì •
        initializePopupColorSelection();
      }

      // ë°°ê²½ ìƒ‰ìƒ íŒì—… ìˆ¨ê¸°ê¸°
      function hideBackgroundColorPopup() {
        console.log("ğŸ¨ ë°°ê²½ ìƒ‰ìƒ íŒì—… ìˆ¨ê¸°ê¸°");
        backgroundColorPopup.style.display = "none";
        pendingProcessingMode = null;
      }

      // ë°°ê²½ ìƒ‰ìƒ í™•ì¸ í›„ ì²˜ë¦¬ ì‹œì‘
      function confirmBackgroundColor() {
        console.log(
          "âœ… ë°°ê²½ ìƒ‰ìƒ í™•ì¸, pendingProcessingMode:",
          pendingProcessingMode
        );
        if (pendingProcessingMode) {
          // ì²˜ë¦¬ ëª¨ë“œë¥¼ ì„ì‹œ ë³€ìˆ˜ì— ì €ì¥
          const modeToProcess = pendingProcessingMode;
          hideBackgroundColorPopup(); // ì´ì œ pendingProcessingModeê°€ nullì´ ë¨
          startVideoProcessing(modeToProcess); // í•˜ì§€ë§Œ ì„ì‹œ ë³€ìˆ˜ ì‚¬ìš©
        } else {
          console.error("âŒ pendingProcessingModeê°€ ì—†ìŠµë‹ˆë‹¤!");
        }
      }

      // íŒì—… ë‚´ ìƒ‰ìƒ ì„ íƒ ì´ˆê¸°í™”
      function initializePopupColorSelection() {
        const popupColorButtons =
          backgroundColorPopup.querySelectorAll(".color-btn");

        // ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±° í›„ ìƒˆë¡œ ì„¤ì •
        popupColorButtons.forEach((btn) => {
          btn.replaceWith(btn.cloneNode(true));
        });

        // ìƒˆë¡œìš´ ë²„íŠ¼ë“¤ì— ì´ë²¤íŠ¸ ì„¤ì •
        const newPopupColorButtons =
          backgroundColorPopup.querySelectorAll(".color-btn");
        newPopupColorButtons.forEach((btn) => {
          btn.addEventListener("click", function () {
            newPopupColorButtons.forEach((b) => b.classList.remove("active"));
            this.classList.add("active");
            selectedBackgroundColor = this.getAttribute("data-color");
            console.log("íŒì—…ì—ì„œ ë°°ê²½ ìƒ‰ìƒ ì„ íƒ:", selectedBackgroundColor);
          });
        });

        // ì»¤ìŠ¤í…€ ìƒ‰ìƒ í”¼ì»¤
        if (popupCustomColorPicker) {
          popupCustomColorPicker.addEventListener("change", function () {
            newPopupColorButtons.forEach((b) => b.classList.remove("active"));
            selectedBackgroundColor = this.value;
            console.log(
              "íŒì—…ì—ì„œ ì»¤ìŠ¤í…€ ë°°ê²½ ìƒ‰ìƒ ì„ íƒ:",
              selectedBackgroundColor
            );
          });
        }
      }

      // ì²˜ë¦¬ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸ (íŒ¨ë„ì— ì§ì ‘ í‘œì‹œ)
      function updateProcessingMessage() {
        if (!processingMainMessage || !processingTipMessage) return;

        const randomMessage =
          funMessages[Math.floor(Math.random() * funMessages.length)];
        const randomTip =
          processingTips[Math.floor(Math.random() * processingTips.length)];

        processingMainMessage.textContent = randomMessage.msg;
        processingTipMessage.textContent =
          Math.random() > 0.5 ? randomMessage.tip : randomTip;
      }

      // ì‹œê°„ í¬ë§·íŒ…
      function formatTime(seconds) {
        if (seconds < 60) return `${Math.round(seconds)}ì´ˆ`;
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.round(seconds % 60);
        return `${minutes}ë¶„ ${remainingSeconds}ì´ˆ`;
      }

      // ë¹„ë””ì˜¤ ì •ë³´ í‘œì‹œ (ì„œë²„ì—ì„œ ë°›ì€ ì •í™•í•œ ë°ì´í„° ì‚¬ìš©)
      function displayVideoInfo(data) {
        // ì„œë²„ì—ì„œ ë°›ì€ ì •í™•í•œ ë¹„ë””ì˜¤ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
        videoProcessingData = {
          width: data.width,
          height: data.height,
          fps: data.fps,
          original_frames: data.original_frames,
          duration: data.duration || leftVideo.duration,
        };

        // ì›ë³¸ ë¹„ë””ì˜¤ ì •ë³´ ì—…ë°ì´íŠ¸ (ì„œë²„ ë°ì´í„° ì‚¬ìš©)
        const videoResolutionEl = document.getElementById("videoResolution");
        if (videoResolutionEl) {
          videoResolutionEl.textContent = `${data.width}x${data.height}`;
        }

        const videoFPSEl = document.getElementById("videoFPS");
        if (videoFPSEl) {
          videoFPSEl.textContent = `${data.fps.toFixed(1)} FPS`;
        }

        const videoTotalFramesEl = document.getElementById("videoTotalFrames");
        if (videoTotalFramesEl) {
          videoTotalFramesEl.textContent = `${data.original_frames}ê°œ`;
        }

        console.log("ë¹„ë””ì˜¤ ì •ë³´ ì—…ë°ì´íŠ¸ ì™„ë£Œ:", videoProcessingData);
      }

      // ì²˜ë¦¬ë  ë¹„ë””ì˜¤ ì •ë³´ ì—…ë°ì´íŠ¸
      function updateProcessingInfo(removeBg, upscale, scaleRatio) {
        if (!videoProcessingData) return;

        // ë³€ê²½ë  í•´ìƒë„ ê³„ì‚°
        let newResolution = "ì›ë³¸ê³¼ ë™ì¼";
        if (upscale) {
          const newWidth = videoProcessingData.width * scaleRatio;
          const newHeight = videoProcessingData.height * scaleRatio;
          newResolution = `${newWidth}x${newHeight} (${scaleRatio}x)`;
        }
        const processedResolutionEl = document.getElementById(
          "processedResolution"
        );
        if (processedResolutionEl) {
          processedResolutionEl.textContent = newResolution;
        }

        // ë°°ê²½ ì œê±° ì—¬ë¶€
        const backgroundRemovalEl =
          document.getElementById("backgroundRemoval");
        if (backgroundRemovalEl) {
          backgroundRemovalEl.textContent = removeBg
            ? "âœ… ì ìš©ë¨"
            : "âŒ ì ìš© ì•ˆí•¨";
        }

        // ì—…ìŠ¤ì¼€ì¼ ì •ë³´
        let upscaleText = "âŒ ì ìš© ì•ˆí•¨";
        if (upscale) {
          upscaleText = `âœ… ${scaleRatio}x ì—…ìŠ¤ì¼€ì¼`;
        }
        const upscaleInfoEl = document.getElementById("upscaleInfo");
        if (upscaleInfoEl) {
          upscaleInfoEl.textContent = upscaleText;
        }
      }

      // í˜„ì¬ í”„ë ˆì„ ì—…ë°ì´íŠ¸ (ì‹¤ì œ íŒŒì¼ ìˆ˜ ê¸°ë°˜)
      function updateCurrentFrame(processedCount, totalFrames) {
        // í˜„ì¬ ì²˜ë¦¬ëœ í”„ë ˆì„ ìˆ˜ì™€ ë¹„ìœ¨ í‘œì‹œ
        const progressPercent =
          totalFrames > 0 ? (processedCount / totalFrames) * 100 : 0;

        // ì²« ë²ˆì§¸ í”„ë ˆì„ ì²˜ë¦¬ ì‹œ ì‹¤ì œ ì²˜ë¦¬ ì‹œì‘ ì‹œê°„ ê¸°ë¡
        if (processedCount === 1 && !window.actualProcessingStartTime) {
          window.actualProcessingStartTime = Date.now();
          console.log("ì‹¤ì œ í”„ë ˆì„ ì²˜ë¦¬ ì‹œì‘ ì‹œê°„ ê¸°ë¡");
        }

        if (window.actualProcessingStartTime && processedCount > 0) {
          const elapsed =
            (Date.now() - window.actualProcessingStartTime) / 1000;
          const avgTimePerFrame = elapsed / processedCount;
          const remainingFrames = totalFrames - processedCount;
          const estimatedRemaining = remainingFrames * avgTimePerFrame;

          console.log(
            `ğŸ¬ ì‹¤ì‹œê°„ ì§„í–‰ë¥ : ${processedCount}/${totalFrames} (${progressPercent.toFixed(
              1
            )}%) - ê²½ê³¼: ${elapsed.toFixed(
              1
            )}ì´ˆ, í‰ê· : ${avgTimePerFrame.toFixed(
              2
            )}ì´ˆ/í”„ë ˆì„, ì˜ˆìƒ ë‚¨ì€ ì‹œê°„: ${estimatedRemaining.toFixed(1)}ì´ˆ`
          );
        }
      }

      // ë¹„ë””ì˜¤ ì²˜ë¦¬ ìƒíƒœ í‘œì‹œ
      function showVideoProcessingStatus() {
        console.log("ğŸ¬ showVideoProcessingStatus() í˜¸ì¶œë¨");

        rightPanel.classList.add("visible");
        emptyState.classList.add("hide");
        rightImageArea.classList.remove("visible");
        videoStatusArea.classList.add("visible");
        mainContainer.classList.remove("upload-only");

        console.log(
          "ğŸ“º videoStatusArea í‘œì‹œ ìƒíƒœ:",
          videoStatusArea.classList.contains("visible")
        );
        console.log("ğŸ“‹ processingMessage ìš”ì†Œ:", processingMessage);

        // ì²˜ë¦¬ ë©”ì‹œì§€ ì£¼ê¸°ì  ì—…ë°ì´íŠ¸ ì‹œì‘
        updateProcessingMessage();
        messageInterval = setInterval(updateProcessingMessage, 8000); // 8ì´ˆë§ˆë‹¤ ë©”ì‹œì§€ ë³€ê²½

        // ì²˜ë¦¬ ì‹œì‘ ì‹œê°„ ì´ˆê¸°í™”
        processingStartTime = Date.now();
        window.actualProcessingStartTime = null; // ì‹¤ì œ í”„ë ˆì„ ì²˜ë¦¬ ì‹œì‘ ì‹œê°„ ì´ˆê¸°í™”

        // ì²˜ë¦¬ ë©”ì‹œì§€ í‘œì‹œ
        if (processingMessage) {
          processingMessage.style.display = "block";
          console.log("ğŸ’¬ processingMessage í‘œì‹œë¨");
        } else {
          console.error("âŒ processingMessage ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ");
        }

        // ê²°ê³¼ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        if (videoResultSection) {
          videoResultSection.style.display = "none";
        }

        console.log("âœ… ë¹„ë””ì˜¤ ì²˜ë¦¬ ìƒíƒœ í‘œì‹œ ì™„ë£Œ");
      }

      // ë¹„ë””ì˜¤ ì²˜ë¦¬ ì™„ë£Œ ì‹œ ì •ë¦¬
      function hideVideoProcessingStatus() {
        console.log("ğŸ”§ hideVideoProcessingStatus ì‹œì‘");

        if (messageInterval) {
          clearInterval(messageInterval);
          messageInterval = null;
          console.log("ğŸ“´ ë©”ì‹œì§€ ì¸í„°ë²Œ ì •ë¦¬ë¨");
        }

        // ì²˜ë¦¬ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
        if (processingMessage) {
          processingMessage.style.display = "none";
          console.log("ğŸ“´ ì²˜ë¦¬ ë©”ì‹œì§€ ìˆ¨ê¹€");
        } else {
          console.error("âŒ processingMessage ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ");
        }

        // ê²°ê³¼ ì˜ì—­ í‘œì‹œ
        if (videoResultSection) {
          videoResultSection.style.display = "block";
          console.log("ğŸ“º ë¹„ë””ì˜¤ ê²°ê³¼ ì„¹ì…˜ í‘œì‹œë¨");
        } else {
          console.error("âŒ videoResultSection ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ");
        }

        console.log("âœ… hideVideoProcessingStatus ì™„ë£Œ");
      }

      // ìƒˆë¡œìš´ ë¹„ë””ì˜¤ ì²˜ë¦¬ ì‹œì‘ í•¨ìˆ˜
      function startVideoProcessing(mode) {
        console.log("ğŸ¬ startVideoProcessing í˜¸ì¶œë¨, mode:", mode);

        if (!currentVideoFile) {
          showMessage("ë¹„ë””ì˜¤ íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.", "error");
          return;
        }

        let removeBg = false;
        let upscale = false;
        let scaleRatio = 2;

        // ëª¨ë“œì— ë”°ë¥¸ ì²˜ë¦¬ ì˜µì…˜ ì„¤ì •
        console.log("ğŸ”§ ì²˜ë¦¬ ëª¨ë“œ ë¶„ì„:", mode, typeof mode);
        switch (mode) {
          case "remove_bg":
            removeBg = true;
            break;
          case "upscale_2x":
            upscale = true;
            scaleRatio = 2;
            break;
          case "upscale_4x":
            upscale = true;
            scaleRatio = 4;
            break;
          case "both_2x":
            removeBg = true;
            upscale = true;
            scaleRatio = 2;
            break;
          case "both_4x":
            removeBg = true;
            upscale = true;
            scaleRatio = 4;
            break;
          default:
            console.error(
              "âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì²˜ë¦¬ ëª¨ë“œ:",
              mode,
              "íƒ€ì…:",
              typeof mode
            );
            showMessage(`ì˜ëª»ëœ ì²˜ë¦¬ ëª¨ë“œì…ë‹ˆë‹¤: ${mode}`, "error");
            return;
        }

        // ì²˜ë¦¬ ì‹œì‘ ì „ì— ì²˜ë¦¬ë  ë¹„ë””ì˜¤ ì •ë³´ ì—…ë°ì´íŠ¸
        updateProcessingInfo(removeBg, upscale, scaleRatio);

        // ì²˜ë¦¬ ì˜µì…˜ì„ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ë‚˜ì¤‘ì— ì‚¬ìš©)
        window.currentProcessingOptions = {
          removeBg: removeBg,
          upscale: upscale,
          scaleRatio: scaleRatio,
        };

        processVideoWithOptions(removeBg, upscale, scaleRatio);
      }

      // ë¹„ë””ì˜¤ ì²˜ë¦¬ í•¨ìˆ˜ (ì˜µì…˜ í¬í•¨)
      function processVideoWithOptions(removeBg, upscale, scaleRatio) {
        console.log("ğŸ¬ ë¹„ë””ì˜¤ ì²˜ë¦¬ ì‹œì‘ - ì˜µì…˜:", {
          removeBg,
          upscale,
          scaleRatio,
          backgroundColorValue: selectedBackgroundColor,
          workIdValue: workId,
          currentVideoFileExists: !!currentVideoFile,
        });

        if (!currentVideoFile) {
          console.error("âŒ currentVideoFileì´ ì—†ìŠµë‹ˆë‹¤!");
          showMessage("ë¹„ë””ì˜¤ íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", "error");
          return;
        }

        const formData = new FormData();
        formData.append("file", currentVideoFile);
        formData.append("remove_bg", removeBg);
        formData.append("upscale", upscale);
        formData.append("scale_factor", scaleRatio);
        formData.append("background_color", selectedBackgroundColor); // ë°°ê²½ ìƒ‰ìƒ ì¶”ê°€
        // í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ìƒì„±í•œ work_id ì „ë‹¬
        if (workId) {
          formData.append("work_id", workId);
        }

        console.log("ğŸ“¤ FormData ì¤€ë¹„ ì™„ë£Œ:", {
          fileSize: currentVideoFile.size,
          fileName: currentVideoFile.name,
          backgroundColor: selectedBackgroundColor,
          workId: workId,
        });

        // ë¹„ë””ì˜¤ ì²˜ë¦¬ ìƒíƒœ í‘œì‹œ ì‹œì‘
        showVideoProcessingStatus();

        // ì²˜ë¦¬ ë²„íŠ¼ë“¤ ë¹„í™œì„±í™”
        const actionButtons = leftVideoActionButtons.querySelectorAll(".btn");
        actionButtons.forEach((btn) => (btn.disabled = true));

        fetch("/process_video", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            // ì²˜ë¦¬ ë²„íŠ¼ë“¤ ì¬í™œì„±í™”
            actionButtons.forEach((btn) => (btn.disabled = false));

            if (data.success) {
              // ì„œë²„ì—ì„œ ë°›ì€ ì •í™•í•œ ë¹„ë””ì˜¤ ì •ë³´ í‘œì‹œ
              displayVideoInfo(data);

              // ì²˜ë¦¬ ì˜µì…˜ì— ë”°ë¥¸ ì •ë³´ ë‹¤ì‹œ ì—…ë°ì´íŠ¸ (ì •í™•í•œ ë°ì´í„° ê¸°ë°˜)
              if (window.currentProcessingOptions) {
                updateProcessingInfo(
                  window.currentProcessingOptions.removeBg,
                  window.currentProcessingOptions.upscale,
                  window.currentProcessingOptions.scaleRatio
                );
              }

              // í”„ë¡œê·¸ë ˆìŠ¤ ìŠ¤íŠ¸ë¦¼ ì—°ê²°
              connectToVideoProgressStream(data.session_id, data);

              // íŒŒì¼ ì¹´ìš´íŠ¸ í´ë§ ì‹œì‘ (ì‹¤ì œ í”„ë ˆì„ ì²˜ë¦¬ ì¶”ì )
              startFileCountPolling(data.session_id);
            } else {
              showMessage(
                data.error || "ë¹„ë””ì˜¤ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
                "error"
              );
              stopFileCountPolling();
              if (messageInterval) {
                clearInterval(messageInterval);
                messageInterval = null;
              }
            }
          })
          .catch((error) => {
            // ì²˜ë¦¬ ë²„íŠ¼ë“¤ ì¬í™œì„±í™”
            actionButtons.forEach((btn) => (btn.disabled = false));
            console.error("Error:", error);
            showMessage("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
            stopFileCountPolling();
            if (messageInterval) {
              clearInterval(messageInterval);
              messageInterval = null;
            }
          });
      }

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      uploadArea.addEventListener("click", () => fileInput.click());

      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("dragover");
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileUpload(files[0]);
        }
      });

      fileInput.addEventListener("change", (e) => {
        if (e.target.files.length > 0) {
          handleFileUpload(e.target.files[0]);
        }
      });

      // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
      function handleFileUpload(file) {
        // íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬
        if (!file.type.startsWith("image/")) {
          showMessage("ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.", "error");
          return;
        }

        if (file.size > 16 * 1024 * 1024) {
          showMessage("íŒŒì¼ í¬ê¸°ëŠ” 16MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.", "error");
          return;
        }

        // ì—…ë¡œë“œ ì¦‰ì‹œ UUID ìƒì„±í•˜ê³  URL ë³€ê²½
        const newWorkId = generateUUID();
        workId = newWorkId;
        window.history.pushState(
          { workId: newWorkId },
          "",
          `/work/${newWorkId}`
        );
        console.log(`ğŸ“ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œ URL ë³€ê²½: /work/${newWorkId}`);

        currentImageFile = file;

        // ì´ë¯¸ì§€ í‘œì‹œ
        const reader = new FileReader();
        reader.onload = (e) => {
          leftImage.src = e.target.result;
          leftImageLabel.textContent = ""; // ë¼ë²¨ ë¹„ìš°ê¸°

          // íˆ¬ëª…ë„ í™•ì¸
          if (file.type === "image/png") {
            checkImageTransparency(e.target.result);
          }

          // UI ì „í™˜
          uploadArea.style.display = "none";
          leftImageArea.classList.add("visible");
          rightPanel.classList.add("visible");
          mainContainer.classList.remove("upload-only");

          // ì—…ë¡œë“œ ìƒíƒœë¥¼ ì¦‰ì‹œ ì„œë²„ì— ì €ì¥ + ì´ë¯¸ì§€ë„ localStorageì— ì €ì¥
          const formData = new FormData();
          formData.append("work_id", workId);
          formData.append("original_filename", file.name);

          // ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ localStorageì—ë„ ì €ì¥
          const imageDataUrl = e.target.result;
          localStorage.setItem(`uploaded_image_${workId}`, imageDataUrl);
          console.log(
            `ğŸ’¾ ì´ë¯¸ì§€ ë°ì´í„° localStorage ì €ì¥ ì™„ë£Œ: uploaded_image_${workId}`
          );

          fetch("/save_upload_state", {
            method: "POST",
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                console.log(`âœ… ì—…ë¡œë“œ ìƒíƒœ ì €ì¥ ì™„ë£Œ: ${workId}`);
                showMessage(
                  "ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! ì›í•˜ëŠ” ì²˜ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.",
                  "success"
                );
              } else {
                console.error("âŒ ì—…ë¡œë“œ ìƒíƒœ ì €ì¥ ì‹¤íŒ¨:", data.error);
                showMessage(
                  "ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! ì›í•˜ëŠ” ì²˜ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.",
                  "success"
                );
              }
            })
            .catch((error) => {
              console.error("âŒ ì—…ë¡œë“œ ìƒíƒœ ì €ì¥ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:", error);
              showMessage(
                "ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! ì›í•˜ëŠ” ì²˜ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.",
                "success"
              );
            });
        };
        reader.readAsDataURL(file);
      }

      // ë¹„ë””ì˜¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      videoUploadArea.addEventListener("click", () => videoFileInput.click());

      videoUploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        videoUploadArea.classList.add("dragover");
      });

      videoUploadArea.addEventListener("dragleave", () => {
        videoUploadArea.classList.remove("dragover");
      });

      videoUploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        videoUploadArea.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleVideoUpload(files[0]);
        }
      });

      videoFileInput.addEventListener("change", (e) => {
        if (e.target.files.length > 0) {
          handleVideoUpload(e.target.files[0]);
        }
      });

      // ë¹„ë””ì˜¤ ì—…ë¡œë“œ ì²˜ë¦¬
      function handleVideoUpload(file) {
        // íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬
        if (!file.type.startsWith("video/")) {
          showMessage("ë¹„ë””ì˜¤ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.", "error");
          return;
        }

        if (file.size > 100 * 1024 * 1024) {
          showMessage("íŒŒì¼ í¬ê¸°ëŠ” 100MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.", "error");
          return;
        }

        // ì—…ë¡œë“œ ì¦‰ì‹œ UUID ìƒì„±í•˜ê³  URL ë³€ê²½
        const newWorkId = generateUUID();
        workId = newWorkId;
        window.history.pushState(
          { workId: newWorkId },
          "",
          `/work/${newWorkId}`
        );
        console.log(`ğŸ“ ë¹„ë””ì˜¤ ì—…ë¡œë“œ ì‹œ URL ë³€ê²½: /work/${newWorkId}`);

        currentVideoFile = file;

        // ë¹„ë””ì˜¤ íŒŒì¼ì„ URLë¡œ ë³€í™˜í•˜ì—¬ í‘œì‹œ
        const videoURL = URL.createObjectURL(file);
        leftVideo.src = videoURL;

        // UI ì „í™˜
        videoUploadArea.style.display = "none";
        leftVideoArea.classList.add("visible");
        rightPanel.classList.add("visible");
        mainContainer.classList.remove("upload-only");

        // ìš°ì¸¡ íŒ¨ë„ì— ë¹„ë””ì˜¤ ìƒíƒœ í‘œì‹œ
        videoStatusArea.classList.add("visible");
        emptyState.classList.add("hide");

        // ì²˜ë¦¬ ë©”ì‹œì§€ ì¦‰ì‹œ í‘œì‹œ (ëŒ€ê¸° ìƒíƒœ)
        if (processingMessage) {
          processingMessage.style.display = "block";
        }
        if (processingMainMessage) {
          processingMainMessage.textContent = "ğŸ¬ ë¹„ë””ì˜¤ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!";
        }
        if (processingTipMessage) {
          processingTipMessage.textContent = "ì²˜ë¦¬í•  ì‘ì—…ì„ ì„ íƒí•´ì£¼ì„¸ìš” âœ¨";
        }

        // ë¹„ë””ì˜¤ ì—…ë¡œë“œ ìƒíƒœë¥¼ ì¦‰ì‹œ ì„œë²„ì— ì €ì¥
        const formData = new FormData();
        formData.append("work_id", workId);
        formData.append("original_filename", file.name);
        formData.append("video_type", "uploaded");

        // ë¹„ë””ì˜¤ URLì„ localStorageì— ì €ì¥ (ë³µì›ìš©)
        localStorage.setItem(`uploaded_video_${workId}`, videoURL);
        localStorage.setItem(`uploaded_video_name_${workId}`, file.name);
        console.log(
          `ğŸ’¾ ë¹„ë””ì˜¤ ë°ì´í„° localStorage ì €ì¥ ì™„ë£Œ: uploaded_video_${workId}`
        );

        fetch("/save_upload_state", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              console.log(`âœ… ë¹„ë””ì˜¤ ì—…ë¡œë“œ ìƒíƒœ ì €ì¥ ì™„ë£Œ: ${workId}`);
            } else {
              console.error("âŒ ë¹„ë””ì˜¤ ì—…ë¡œë“œ ìƒíƒœ ì €ì¥ ì‹¤íŒ¨:", data.error);
            }
          })
          .catch((error) => {
            console.error("âŒ ë¹„ë””ì˜¤ ì—…ë¡œë“œ ìƒíƒœ ì €ì¥ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:", error);
          });

        // ë¹„ë””ì˜¤ ë©”íƒ€ë°ì´í„° ë¡œë“œ ì‹œ ì¦‰ì‹œ ì›ë³¸ ì •ë³´ í‘œì‹œ
        leftVideo.addEventListener("loadedmetadata", function initVideoData() {
          // ì‹¤ì œ ë¹„ë””ì˜¤ ë°ì´í„°ë¡œ ì´ˆê¸°í™” (ì •í™•í•œ FPSëŠ” ì„œë²„ì—ì„œ ë°›ì„ ì˜ˆì •)
          videoProcessingData = {
            width: leftVideo.videoWidth,
            height: leftVideo.videoHeight,
            fps: null, // ì„œë²„ì—ì„œ ì •í™•í•œ ê°’ì„ ë°›ì„ ì˜ˆì •
            original_frames: null, // ì„œë²„ì—ì„œ ì •í™•í•œ ê°’ì„ ë°›ì„ ì˜ˆì •
            duration: leftVideo.duration,
          };

          // íŒŒì¼ í¬ë§· ì •ë³´ í‘œì‹œ
          const fileExtension = file.name.split(".").pop().toUpperCase();
          const videoFormatEl = document.getElementById("videoFormat");
          if (videoFormatEl) {
            videoFormatEl.textContent = fileExtension;
          }

          // í•´ìƒë„, FPS, í”„ë ˆì„ ì •ë³´ í‘œì‹œ
          const videoResolutionEl = document.getElementById("videoResolution");
          if (videoResolutionEl) {
            videoResolutionEl.textContent = `${videoProcessingData.width}x${videoProcessingData.height}`;
          }

          const videoFPSEl = document.getElementById("videoFPS");
          if (videoFPSEl) {
            videoFPSEl.textContent = `ë¶„ì„ ì¤‘...`;
          }

          const videoTotalFramesEl =
            document.getElementById("videoTotalFrames");
          if (videoTotalFramesEl) {
            videoTotalFramesEl.textContent = `ë¶„ì„ ì¤‘...`;
          }

          // ì´ˆê¸° ì²˜ë¦¬ ì •ë³´ ì„¤ì • (ì•„ë¬´ê²ƒë„ ì ìš© ì•ˆí•¨)
          const processedResolutionEl = document.getElementById(
            "processedResolution"
          );
          if (processedResolutionEl) {
            processedResolutionEl.textContent = "ì›ë³¸ê³¼ ë™ì¼";
          }

          const backgroundRemovalEl =
            document.getElementById("backgroundRemoval");
          if (backgroundRemovalEl) {
            backgroundRemovalEl.textContent = "ì ìš© ì˜ˆì •";
          }

          const upscaleInfoEl = document.getElementById("upscaleInfo");
          if (upscaleInfoEl) {
            upscaleInfoEl.textContent = "ì ìš© ì˜ˆì •";
          }

          // ì´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
          leftVideo.removeEventListener("loadedmetadata", initVideoData);
        });

        const fileSizeMB = (file.size / (1024 * 1024)).toFixed(1);
        showMessage(
          `ë¹„ë””ì˜¤ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! (${fileSizeMB}MB) ì›í•˜ëŠ” ì²˜ë¦¬ ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”.`,
          "success"
        );
      }

      // íˆ¬ëª…ë„ í™•ì¸
      function checkImageTransparency(src) {
        const img = new Image();
        img.onload = function () {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);

          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;

          for (let i = 3; i < data.length; i += 4) {
            if (data[i] < 255) {
              isTransparentImage = true;
              if (leftImage.parentElement) {
                leftImage.parentElement.classList.add("transparency-bg");
              }
              break;
            }
          }
        };
        img.src = src;
      }

      // ì´ë¯¸ì§€ ì²˜ë¦¬ (ì¢Œì¸¡ì—ì„œ)
      function processImage(type, scale = 4) {
        if (!currentImageFile) {
          showMessage("ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.", "error");
          return;
        }

        emptyState.classList.add("hide");
        rightImageArea.classList.remove("visible");

        const formData = new FormData();
        formData.append("file", currentImageFile);
        // í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ìƒì„±í•œ work_id ì „ë‹¬
        if (workId) {
          formData.append("work_id", workId);
        }

        let endpoint = "/upload";
        let processingName = "ë°°ê²½ ì œê±°";

        if (type === "upscale") {
          endpoint = "/upscale";
          formData.append("scale", scale.toString());
          processingName = `${scale}x ì—…ìŠ¤ì¼€ì¼`;
        }

        let progressStream = null;

        fetch(endpoint, {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              showMessage(data.error, "error");
            } else {
              // í”„ë¡œê·¸ë˜ìŠ¤ ìŠ¤íŠ¸ë¦¼ ì—°ê²°
              if (data.session_id) {
                progressStream = connectToProgressStream(data.session_id);
              }

              // ì²˜ë¦¬ ì™„ë£Œ í›„ ê²°ê³¼ í‘œì‹œ
              setTimeout(() => {
                rightImage.src = data.download_url;
                rightImageLabel.textContent = `${processingName} ì™„ë£Œ âœ¨`;
                rightImageArea.classList.add("visible");

                // ë°°ê²½ì œê±° ê²°ê³¼ì¸ ê²½ìš° íˆ¬ëª…ë„ ë°°ê²½ ì ìš©
                if (type === "background") {
                  rightImage.parentElement.classList.add("transparency-bg");
                  updateRightActionButtons(true);
                } else {
                  rightImage.parentElement.classList.remove("transparency-bg");
                  updateRightActionButtons(false);
                }

                currentDownloadUrl = data.download_url;
                setupDownloadButton();

                // localStorageì—ì„œ ì„ì‹œ ì´ë¯¸ì§€ ë°ì´í„° ì •ë¦¬
                if (workId) {
                  localStorage.removeItem(`uploaded_image_${workId}`);
                  console.log(
                    `ğŸ§¹ localStorage ì„ì‹œ ì´ë¯¸ì§€ ì •ë¦¬ ì™„ë£Œ: uploaded_image_${workId}`
                  );
                }

                showMessage(`${processingName}ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`, "success");
              }, 1000);
            }
          })
          .catch((error) => {
            if (progressStream) {
              progressStream.close();
            }
            showMessage("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
            console.error("Error:", error);
          });
      }

      // ì—°ì† ì²˜ë¦¬ (ìš°ì¸¡ ê²°ê³¼ì—ì„œ)
      function continueProcessing(type, scale = 4) {
        if (!currentDownloadUrl) {
          showMessage("ì²˜ë¦¬í•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.", "error");
          return;
        }

        // í˜„ì¬ ê²°ê³¼ë¥¼ ì¢Œì¸¡ìœ¼ë¡œ ì´ë™
        fetch(currentDownloadUrl)
          .then((response) => response.blob())
          .then((blob) => {
            const file = new File([blob], `processed_image.png`, {
              type: "image/png",
            });
            currentImageFile = file;

            // ì¢Œì¸¡ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
            leftImage.src = currentDownloadUrl;
            leftImageLabel.textContent = "í˜„ì¬ ì´ë¯¸ì§€";

            // íˆ¬ëª…ë„ ë°°ê²½ ì²˜ë¦¬
            if (
              rightImage.parentElement.classList.contains("transparency-bg")
            ) {
              leftImage.parentElement.classList.add("transparency-bg");
            } else {
              leftImage.parentElement.classList.remove("transparency-bg");
            }

            // ìƒˆë¡œìš´ ì²˜ë¦¬ ì‹œì‘
            processImage(type, scale);
          })
          .catch((error) => {
            showMessage("ì´ë¯¸ì§€ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
            console.error("Error:", error);
          });
      }

      // ìš°ì¸¡ ì•¡ì…˜ ë²„íŠ¼ ì—…ë°ì´íŠ¸
      function updateRightActionButtons(isBackgroundRemoved) {
        const buttons = rightActionButtons.querySelectorAll(".btn");
        buttons.forEach((btn) => {
          if (btn.classList.contains("background-remove")) {
            btn.style.display = isBackgroundRemoved ? "none" : "inline-block";
          }
        });
      }

      // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì„¤ì •
      function setupDownloadButton() {
        downloadBtn.onclick = () => {
          if (currentDownloadUrl) {
            window.open(currentDownloadUrl, "_blank");
          }
        };
      }

      // í”„ë¡œê·¸ë ˆìŠ¤ ìŠ¤íŠ¸ë¦¼ ì—°ê²° (ê¸°ì¡´ ì´ë¯¸ì§€ìš©)
      function connectToProgressStream(sessionId) {
        const eventSource = new EventSource(`/progress/${sessionId}`);

        eventSource.onmessage = function (event) {
          try {
            const data = JSON.parse(event.data);
            console.log(
              `í”„ë¡œê·¸ë ˆìŠ¤ ì—…ë°ì´íŠ¸: ${data.progress}% - ${data.message}`
            );

            if (data.progress >= 100) {
              eventSource.close();
            }
          } catch (e) {
            console.error("Progress parsing error:", e);
          }
        };

        eventSource.onerror = function (event) {
          console.error("Progress stream error:", event);
          eventSource.close();
        };

        return eventSource;
      }

      // ì‹¤ì œ íŒŒì¼ ìˆ˜ í™•ì¸ í´ë§ (í•µì‹¬ ê¸°ëŠ¥)
      let fileCountPollingInterval = null;
      let currentSessionId = null;

      function startFileCountPolling(sessionId) {
        currentSessionId = sessionId;

        // 2ì´ˆë§ˆë‹¤ ì‹¤ì œ íŒŒì¼ ìˆ˜ í™•ì¸
        fileCountPollingInterval = setInterval(async () => {
          try {
            const response = await fetch(`/video_progress_files/${sessionId}`);
            if (response.ok) {
              const data = await response.json();

              console.log(
                `ì‹¤ì œ íŒŒì¼ ìˆ˜ í´ë§: processed=${data.processed_count}, total=${data.total_frames}, completed=${data.completed}`
              );

              // ì‹¤ì œ íŒŒì¼ ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ í”„ë ˆì„ ì—…ë°ì´íŠ¸
              updateCurrentFrame(data.processed_count, data.total_frames);

              // ì™„ë£Œ ì²´í¬ - ì„œë²„ì—ì„œ completed=trueì´ê±°ë‚˜ ì²˜ë¦¬ëœ í”„ë ˆì„ ìˆ˜ê°€ ì´ í”„ë ˆì„ ìˆ˜ì— ë„ë‹¬í•˜ë©´ ì™„ë£Œ
              if (
                data.completed ||
                (data.processed_count >= data.total_frames &&
                  data.total_frames > 0)
              ) {
                console.log(
                  `ğŸ¬ ë¹„ë””ì˜¤ ì²˜ë¦¬ ì™„ë£Œ! completed=${data.completed}, frames=${data.processed_count}/${data.total_frames}`
                );
                console.log("ğŸ“Š ì™„ë£Œ ë°ì´í„°:", data);

                clearInterval(fileCountPollingInterval);
                fileCountPollingInterval = null;

                // ì²˜ë¦¬ ì™„ë£Œ ì²˜ë¦¬
                handleVideoProcessingComplete(data);
              }
            } else {
              console.log(
                `âŒ í´ë§ ì‹¤íŒ¨ (${response.status}): ì„¸ì…˜ì´ ì •ë¦¬ë˜ì—ˆê±°ë‚˜ ì™„ë£Œë˜ì—ˆì„ ìˆ˜ ìˆìŒ`
              );
              // 404 ì—ëŸ¬ê°€ ì§€ì†ë˜ë©´ 1ë¶„ í›„ í´ë§ ì¤‘ì§€
              if (response.status === 404) {
                const now = Date.now();
                if (!window.lastPollingErrorTime) {
                  window.lastPollingErrorTime = now;
                } else if (now - window.lastPollingErrorTime > 60000) {
                  // 1ë¶„
                  console.log("ğŸ›‘ 1ë¶„ê°„ 404 ì—ëŸ¬ ì§€ì†, í´ë§ ì¤‘ì§€");
                  clearInterval(fileCountPollingInterval);
                  fileCountPollingInterval = null;
                  showMessage(
                    "ë¹„ë””ì˜¤ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.",
                    "error"
                  );
                }
              }
            }
          } catch (error) {
            console.error("íŒŒì¼ ìˆ˜ í´ë§ ì˜¤ë¥˜:", error);
          }
        }, 2000); // 2ì´ˆë§ˆë‹¤ í´ë§

        console.log(`íŒŒì¼ ìˆ˜ í´ë§ ì‹œì‘: session=${sessionId}`);
      }

      function stopFileCountPolling() {
        if (fileCountPollingInterval) {
          clearInterval(fileCountPollingInterval);
          fileCountPollingInterval = null;
          console.log("íŒŒì¼ ìˆ˜ í´ë§ ì¤‘ì§€");
        }
      }

      // ë¹„ë””ì˜¤ ì²˜ë¦¬ ì™„ë£Œ ì²˜ë¦¬
      function handleVideoProcessingComplete(data) {
        console.log("ğŸ‰ ë¹„ë””ì˜¤ ì²˜ë¦¬ ì™„ë£Œ ì²˜ë¦¬ ì‹œì‘:", data);

        // ì‹œê°„ ë³€ìˆ˜ ì •ë¦¬
        processingStartTime = null;
        window.actualProcessingStartTime = null;

        // íŒŒì¼ ì¹´ìš´íŠ¸ í´ë§ ì¤‘ì§€
        stopFileCountPolling();

        // UI ì™„ë£Œ ì²˜ë¦¬
        hideVideoProcessingStatus();

        // ë‹¤ìš´ë¡œë“œ URL ì„¤ì • (work_id ê¸°ë°˜)
        console.log("ğŸ”— ë‹¤ìš´ë¡œë“œ URL ì„¤ì • ì‹œì‘:");
        console.log("  - data:", data);
        console.log(
          "  - data.download_url:",
          data ? data.download_url : "data ì—†ìŒ"
        );
        console.log("  - workId:", workId);

        if (data && data.download_url) {
          currentDownloadUrl = data.download_url;
          console.log("âœ… ë°±ì—”ë“œì—ì„œ ë°›ì€ URL ì‚¬ìš©:", currentDownloadUrl);
        } else if (workId) {
          // work_idë¥¼ ì´ìš©í•´ ë‹¤ìš´ë¡œë“œ URL ìƒì„±
          currentDownloadUrl = `/download/${workId}`;
          console.log("ğŸ”§ work_id ê¸°ë°˜ URL ìƒì„±:", currentDownloadUrl);
        } else {
          console.error(
            "âŒ ë‹¤ìš´ë¡œë“œ URLì„ ì„¤ì •í•  ìˆ˜ ì—†ìŒ - data.download_urlê³¼ workId ëª¨ë‘ ì—†ìŒ"
          );
        }

        setupVideoDownloadButton();

        // localStorageì—ì„œ ë¹„ë””ì˜¤ ë°ì´í„° ì •ë¦¬
        if (workId) {
          localStorage.removeItem(`uploaded_video_${workId}`);
          localStorage.removeItem(`uploaded_video_name_${workId}`);
          console.log(
            `ğŸ§¹ localStorage ë¹„ë””ì˜¤ ë°ì´í„° ì •ë¦¬ ì™„ë£Œ: uploaded_video_${workId}`
          );
        }

        // ì™„ë£Œ ë©”ì‹œì§€
        showMessage("ğŸ‰ ë¹„ë””ì˜¤ ì²˜ë¦¬ ì™„ë£Œ!", "success");
      }

      // ë¹„ë””ì˜¤ í”„ë¡œê·¸ë ˆìŠ¤ ìŠ¤íŠ¸ë¦¼ ì—°ê²°
      function connectToVideoProgressStream(sessionId, videoData) {
        const eventSource = new EventSource(`/progress/${sessionId}`);

        eventSource.onmessage = function (event) {
          try {
            const data = JSON.parse(event.data);

            console.log(
              `ë¹„ë””ì˜¤ í”„ë¡œê·¸ë ˆìŠ¤: ${data.progress}% - ${data.message}`
            );

            if (data.progress >= 100) {
              // SSE ì™„ë£Œ ì‹ í˜¸ - ì‹¤ì œ ì™„ë£ŒëŠ” íŒŒì¼ ì¹´ìš´íŠ¸ í´ë§ì—ì„œ ì²˜ë¦¬
              console.log(
                "ğŸ“¡ SSE ìŠ¤íŠ¸ë¦¼ì—ì„œ ì™„ë£Œ ì‹ í˜¸ ë°›ìŒ - íŒŒì¼ ì¹´ìš´íŠ¸ í´ë§ì´ ì‹¤ì œ ì™„ë£Œë¥¼ ì²˜ë¦¬í•¨"
              );
              eventSource.close();
            }
          } catch (e) {
            console.error("Progress parsing error:", e);
            console.error("Raw event data:", event.data);
          }
        };

        eventSource.onerror = function (event) {
          console.error("Progress stream error:", event);
          eventSource.close();

          // ì˜¤ë¥˜ ì‹œ ì •ë¦¬
          if (messageInterval) {
            clearInterval(messageInterval);
            messageInterval = null;
          }
        };

        return eventSource;
      }

      // ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì„¤ì •
      function setupVideoDownloadButton() {
        console.log("ğŸ”§ setupVideoDownloadButton ì‹œì‘");
        console.log("ğŸ“‹ videoDownloadBtn ìš”ì†Œ:", videoDownloadBtn);
        console.log("ğŸ“‹ currentDownloadUrl:", currentDownloadUrl);

        if (videoDownloadBtn) {
          videoDownloadBtn.onclick = () => {
            console.log("ğŸ”½ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­ë¨, URL:", currentDownloadUrl);
            if (currentDownloadUrl) {
              window.open(currentDownloadUrl, "_blank");
            } else {
              console.error("âŒ ë‹¤ìš´ë¡œë“œ URLì´ ì—†ìŠµë‹ˆë‹¤!");
            }
          };
          console.log("âœ… ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì„¤ì • ì™„ë£Œ");
        } else {
          console.error("âŒ videoDownloadBtn ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ!");
        }
      }

      // ë©”ì‹œì§€ í‘œì‹œ
      function showMessage(message, type = "error") {
        messageContainer.innerHTML = `
          <div class="${type}-message">
            ${message}
          </div>
        `;

        setTimeout(() => {
          messageContainer.innerHTML = "";
        }, 3000);
      }

      // ì• í”Œë¦¬ì¼€ì´ì…˜ ë¦¬ì…‹
      function resetApplication() {
        // work_idê°€ ìˆëŠ” ê²½ìš° ì„œë²„ì— ë¦¬ì…‹ ìš”ì²­ í›„ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
        if (workId && workId.trim() !== "") {
          // ì„œë²„ì— ì„¸ì…˜ ë¦¬ì…‹ ìš”ì²­
          fetch(`/reset/${workId}`, {
            method: "POST",
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                console.log("ğŸ§¹ ì„œë²„ ì„¸ì…˜ ì •ë¦¬ ì™„ë£Œ:", data.cleaned_items);
                showMessage(
                  "ì‘ì—…ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.",
                  "success"
                );

                // 1ì´ˆ í›„ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
                setTimeout(() => {
                  window.location.href = "/";
                }, 1000);
              } else {
                console.error("ì„¸ì…˜ ë¦¬ì…‹ ì‹¤íŒ¨:", data.error);
                // ì„œë²„ ë¦¬ì…‹ ì‹¤íŒ¨ ì‹œì—ë„ í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ í˜ì´ì§€ ì´ë™
                showMessage("ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.", "success");
                setTimeout(() => {
                  window.location.href = "/";
                }, 1000);
              }
            })
            .catch((error) => {
              console.error("ë¦¬ì…‹ ìš”ì²­ ì˜¤ë¥˜:", error);
              // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œì—ë„ í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ í˜ì´ì§€ ì´ë™
              showMessage("ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.", "success");
              setTimeout(() => {
                window.location.href = "/";
              }, 1000);
            });
        } else {
          // work_idê°€ ì—†ëŠ” ê²½ìš° (ë©”ì¸ í˜ì´ì§€ì—ì„œ) ë¡œì»¬ ë¦¬ì…‹ë§Œ ìˆ˜í–‰
          performLocalReset();
        }
      }

      // ë¡œì»¬ ìƒíƒœ ë¦¬ì…‹ (ê¸°ì¡´ ë¡œì§)
      function performLocalReset() {
        fileInput.value = "";
        videoFileInput.value = "";

        // ë¹„ë””ì˜¤ ì²˜ë¦¬ ê´€ë ¨ ì •ë¦¬
        if (messageInterval) {
          clearInterval(messageInterval);
          messageInterval = null;
        }

        // ìƒíƒœ ì´ˆê¸°í™”
        videoProcessingData = null;
        processingStartTime = null;
        currentDownloadUrl = null;
        currentVideoFile = null;
        currentImageFile = null;
        pendingProcessingMode = null;

        // íŒì—… ë‹«ê¸°
        if (backgroundColorPopup) {
          backgroundColorPopup.style.display = "none";
        }

        // ë¹„ë””ì˜¤ URL ì •ë¦¬ (ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€)
        if (leftVideo && leftVideo.src) {
          URL.revokeObjectURL(leftVideo.src);
          leftVideo.src = "";
        }

        if (currentMode === "image") {
          initializeApp();
        } else {
          initializeVideoMode();
        }

        showMessage("ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
      }

      // ì´ˆê¸°í™” ë° ìƒíƒœ ë³µì›
      function initializeAppWithRestore() {
        // work_dataê°€ ìˆìœ¼ë©´ ìƒíƒœ ë³µì›
        if (workData) {
          console.log("âœ… ì‘ì—… ìƒíƒœ ë³µì› ì‹œì‘:", workData);

          if (
            workData.completed &&
            (workData.type === "image" || workData.type === "upscale")
          ) {
            // ì™„ë£Œëœ ì´ë¯¸ì§€/ì—…ìŠ¤ì¼€ì¼ ì‘ì—… ë³µì›
            currentMode = "image";
            switchMode("image");

            // UI ìƒíƒœ ì„¤ì •
            uploadArea.style.display = "none";
            leftImageArea.classList.add("visible");
            rightPanel.classList.add("visible");
            rightImageArea.classList.add("visible");
            emptyState.classList.add("hide");
            mainContainer.classList.remove("upload-only");

            // ì¢Œì¸¡ íŒ¨ë„ - ì›ë³¸ ì´ë¯¸ì§€ í‘œì‹œ (ì²˜ë¦¬ëœ ì´ë¯¸ì§€ë¥¼ ë³´ì—¬ì¤Œ)
            leftImage.src = workData.download_url;
            leftImageLabel.textContent = ""; // ë¼ë²¨ ë¹„ìš°ê¸°

            // ìš°ì¸¡ íŒ¨ë„ - ì²˜ë¦¬ ê²°ê³¼ë„ ë™ì¼í•˜ê²Œ í‘œì‹œ (ì‚¬ìš©ìê°€ ê³„ì† ì‘ì—…í•  ìˆ˜ ìˆë„ë¡)
            rightImage.src = workData.download_url;
            rightImageLabel.textContent =
              workData.type === "upscale"
                ? `${workData.scale}x ì—…ìŠ¤ì¼€ì¼ ì™„ë£Œ âœ¨`
                : "ë°°ê²½ ì œê±° ì™„ë£Œ âœ¨";

            // í˜„ì¬ ì´ë¯¸ì§€ íŒŒì¼ ìƒíƒœ ì„¤ì • (ì¶”ê°€ ì²˜ë¦¬ë¥¼ ìœ„í•´)
            fetch(workData.download_url)
              .then((response) => response.blob())
              .then((blob) => {
                currentImageFile = new File([blob], workData.filename, {
                  type: "image/png",
                });
                console.log(
                  "ğŸ“ currentImageFile ë³µì›ë¨:",
                  currentImageFile.name
                );
              })
              .catch((error) => {
                console.error("âŒ ì´ë¯¸ì§€ íŒŒì¼ ë³µì› ì‹¤íŒ¨:", error);
              });

            // íˆ¬ëª…ë„ ë°°ê²½ ì„¤ì • (ë°°ê²½ ì œê±°ì¸ ê²½ìš°)
            if (workData.type === "image") {
              rightImage.parentElement.classList.add("transparency-bg");
              updateRightActionButtons(true);
            } else {
              rightImage.parentElement.classList.remove("transparency-bg");
              updateRightActionButtons(false);
            }

            // ë‹¤ìš´ë¡œë“œ URL ì„¤ì •
            currentDownloadUrl = workData.download_url;
            setupDownloadButton();
          } else if (workData.type === "uploaded" && !workData.completed) {
            // ì—…ë¡œë“œë§Œ ëœ ìƒíƒœ ë³µì› (ì²˜ë¦¬ëŠ” ì•„ì§ ì•ˆ í•¨)
            console.log("ğŸ“¤ ì—…ë¡œë“œë§Œ ëœ ìƒíƒœ ë³µì›:", workData);

            if (workData.video_type === "uploaded") {
              // ë¹„ë””ì˜¤ ì—…ë¡œë“œë§Œ ëœ ìƒíƒœ ë³µì›
              currentMode = "video";
              switchMode("video");

              // UI ìƒíƒœ ì„¤ì •
              videoUploadArea.style.display = "none";
              leftVideoArea.classList.add("visible");
              rightPanel.classList.add("visible");
              videoStatusArea.classList.add("visible");
              emptyState.classList.add("hide");
              mainContainer.classList.remove("upload-only");

              // localStorageì—ì„œ ë¹„ë””ì˜¤ ë°ì´í„° ë³µì›
              const savedVideoURL = localStorage.getItem(
                `uploaded_video_${workId}`
              );
              const savedVideoName = localStorage.getItem(
                `uploaded_video_name_${workId}`
              );

              if (savedVideoURL && savedVideoName) {
                leftVideo.src = savedVideoURL;
                console.log(
                  `ğŸ“ localStorageì—ì„œ ë¹„ë””ì˜¤ ë³µì› ì™„ë£Œ: uploaded_video_${workId}`
                );

                // ì²˜ë¦¬ ë©”ì‹œì§€ í‘œì‹œ (ëŒ€ê¸° ìƒíƒœ)
                if (processingMessage) {
                  processingMessage.style.display = "block";
                }
                if (processingMainMessage) {
                  processingMainMessage.textContent =
                    "ğŸ¬ ì—…ë¡œë“œëœ ë¹„ë””ì˜¤ê°€ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤!";
                }
                if (processingTipMessage) {
                  processingTipMessage.textContent =
                    "ì²˜ë¦¬í•  ì‘ì—…ì„ ì„ íƒí•´ì£¼ì„¸ìš” âœ¨";
                }

                showMessage(
                  "âœ… ì´ì „ì— ì—…ë¡œë“œëœ ë¹„ë””ì˜¤ê°€ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤! ì²˜ë¦¬ë¥¼ ê³„ì†í•˜ì„¸ìš”.",
                  "success"
                );
              } else {
                // localStorageì— ë¹„ë””ì˜¤ê°€ ì—†ëŠ” ê²½ìš°
                if (processingMainMessage) {
                  processingMainMessage.textContent =
                    "âš ï¸ ë¹„ë””ì˜¤ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤";
                }
                if (processingTipMessage) {
                  processingTipMessage.textContent = "ë‹¤ì‹œ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”";
                }
                showMessage(
                  "âš ï¸ ì´ì „ ì—…ë¡œë“œ ì •ë³´ëŠ” ìˆì§€ë§Œ ë¹„ë””ì˜¤ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.",
                  "error"
                );
              }
            } else {
              // ì´ë¯¸ì§€ ì—…ë¡œë“œë§Œ ëœ ìƒíƒœ ë³µì›
              currentMode = "image";
              switchMode("image");

              // UI ìƒíƒœ ì„¤ì • (ìš°ì¸¡ íŒ¨ë„ì€ ë¹ˆ ìƒíƒœë¡œ)
              uploadArea.style.display = "none";
              leftImageArea.classList.add("visible");
              rightPanel.classList.add("visible");
              emptyState.classList.remove("hide");
              rightImageArea.classList.remove("visible");
              mainContainer.classList.remove("upload-only");

              // localStorageì—ì„œ ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
              const savedImageData = localStorage.getItem(
                `uploaded_image_${workId}`
              );
              if (savedImageData) {
                leftImage.src = savedImageData;
                leftImageLabel.textContent = ""; // ë¼ë²¨ ë¹„ìš°ê¸°

                console.log(
                  `ğŸ“ localStorageì—ì„œ ì´ë¯¸ì§€ ë³µì› ì™„ë£Œ: uploaded_image_${workId}`
                );

                // currentImageFile ë³µì› (ì¶”ê°€ ì²˜ë¦¬ë¥¼ ìœ„í•´)
                fetch(savedImageData)
                  .then((response) => response.blob())
                  .then((blob) => {
                    currentImageFile = new File(
                      [blob],
                      workData.original_filename,
                      {
                        type: "image/png",
                      }
                    );
                    console.log(
                      "ğŸ“ ì—…ë¡œë“œëœ currentImageFile ë³µì›ë¨:",
                      currentImageFile.name
                    );
                  })
                  .catch((error) => {
                    console.error("âŒ ì—…ë¡œë“œëœ ì´ë¯¸ì§€ íŒŒì¼ ë³µì› ì‹¤íŒ¨:", error);
                  });

                // ì—…ë¡œë“œëœ ìƒíƒœ ë©”ì‹œì§€
                showMessage(
                  "âœ… ì´ì „ì— ì—…ë¡œë“œëœ ì´ë¯¸ì§€ê°€ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤! ì²˜ë¦¬ë¥¼ ê³„ì†í•˜ì„¸ìš”.",
                  "success"
                );
              } else {
                // localStorageì— ì´ë¯¸ì§€ê°€ ì—†ëŠ” ê²½ìš° (ì´ì „ ë²„ì „ í˜¸í™˜ì„± ë˜ëŠ” localStorage ì‚­ì œë¨)
                leftImageLabel.textContent = ""; // ë¼ë²¨ ë¹„ìš°ê¸°
                showMessage(
                  "âš ï¸ ì´ì „ ì—…ë¡œë“œ ì •ë³´ëŠ” ìˆì§€ë§Œ ì´ë¯¸ì§€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.",
                  "error"
                );
              }
            }
          } else if (workData.completed && workData.type === "video") {
            // ì™„ë£Œëœ ë¹„ë””ì˜¤ ì‘ì—… ë³µì›
            currentMode = "video";
            switchMode("video");

            // UI ìƒíƒœ ì„¤ì •
            videoUploadArea.style.display = "none";
            rightPanel.classList.add("visible");
            videoStatusArea.classList.add("visible");
            emptyState.classList.add("hide");
            mainContainer.classList.remove("upload-only");

            // ë¹„ë””ì˜¤ ì²˜ë¦¬ ì™„ë£Œ ìƒíƒœ í‘œì‹œ
            hideVideoProcessingStatus();

            // ë‹¤ìš´ë¡œë“œ URL ì„¤ì •
            currentDownloadUrl = workData.download_url;
            setupVideoDownloadButton();

            console.log("ğŸ“¹ ë¹„ë””ì˜¤ ìƒíƒœ ë³µì› ì™„ë£Œ:", {
              filename: workData.filename,
              processing_info: workData.processing_info,
              download_url: workData.download_url,
            });
          }

          showMessage("âœ… ì´ì „ ì‘ì—… ìƒíƒœê°€ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤!", "success");
          console.log("ğŸ‰ ìƒíƒœ ë³µì› ì™„ë£Œ");
        } else {
          // ìƒˆ ì‘ì—… ì‹œì‘
          console.log("ğŸ†• ìƒˆ ì‘ì—… ì‹œì‘");
          initializeApp();
        }
      }

      // ì´ˆê¸°í™”
      document.addEventListener("DOMContentLoaded", function () {
        initializeAppWithRestore();
      });
    </script>
  </body>
</html>
